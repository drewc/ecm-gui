#+TITLE: Gerbil: The real meta-scheme

#+begin_src scheme :tangle foo.ss
(export foo)
(defsyntax (foo stx)
  (syntax-case stx ()
    ((macro name id)
     #'(module name (export id) (def id 1)))
  ((macro id)
   (with-syntax ((n (datum->syntax #'macro 'bar)))
     #'(module n (export id) (def id 1))))))
#+end_src

#+begin_src scheme :tangle bar.ss
(import ./foo)
(foo baz)
#+end_src


#+begin_src scheme :tangle test-dep.ss
(export #t)
(defsyntax (define-endpoint stx)
  (syntax-case stx ()
  ((macro id)
   (with-syntax ((n (datum->syntax #'macro 'bar)))
     #'(module n (export id) (def id 1))))))
#+end_src
#+begin_src scheme :tangle test-jep.ss
(export #t)
(import ./test-dep)
(defsyntax (define-json-endpoint stx)
  (syntax-case stx ()
   ((macro id) #'(begin (define-endpoint name )))))
#+end_src
#+begin_src scheme :tangle test-uep.ss
(import ./test-jep)
(define-json-endpoint foo )
#+end_src
#+begin_src scheme :tangle ./test-build.ss :shebang #!/usr/bin/env gxi
(import :std/build-script)
(defbuild-script
  '("test-dep" "test-uep" "test-jep")
    verbose: 10
    static: #t)
#+end_src



* The Package file

#+begin_src scheme :tangle gerbil.pkg
(package: ecm/gui)
#+end_src

* The build file

#+begin_src scheme :tangle build.ss :shebang #!/usr/bin/env gxi
;; -*- Gerbil -*-

(import :std/build-script)

(import :std/build-script :std/make
        :gerbil/gambit/ports :gerbil/compiler/driver)

(def gerbil-path (getenv "GERBIL_PATH" "~/.gerbil"))
(def gerbil-home (getenv "GERBIL_HOME" gxc#default-gerbil-home))
(def gerbil-gsc std/make#gerbil-gsc)
(def gambcsharp (path-expand "lib/static/gx-gambc#.scm" gerbil-home))

(def (g-compile-static-exe file)
  (def fn (path-strip-extension file))
  (def scmx (string-append fn ".scmx"))
  (def bin (path-expand (path-strip-directory fn) "./bin/"))
  (def -e (string-append "(include \"" gambcsharp "\")"))
  (def (gxcomp)
    (compile-static-exe
     (string-append fn ".ss")
     [ verbose: #t
       invoke-gsc: #f
       output-file: file keep-scm: #t
     ]))
  (def (gscomp)
    (let* ((proc (open-process
                  [path: (gerbil-gsc)
                   arguments: [ #;"-:i8,f8,-8,t8" "-verbose" "-exe" "-o" bin "-e" -e scmx]
                   stdout-redirection: #f]))
         (status (process-status proc)))
    (close-port proc)
    (unless (zero? status)
      (error "Compilation error; gsc exited with nonzero status" status)))
    )
  (gxcomp)
  #;(shell-command (string-append
                  "sed 's/(optimize-dead-definitions)//g' -i "
                  scmx))
  (gscomp))

(def srcdir
  (path-normalize (path-directory (this-source-file))))

(def (build-lib)
(defbuild-script
  '("server/httpd" "endpoints/login" "auth" "conf" "database"
   "endpoints/report/pmi" "ecm-gui")
  
  ;'("test-dep" "test-uep" "test-jep" "endpoints/report/pmi")
    verbose: 1
    ;bindir: srcdir
    ; libdir: srcdir
    static: #t)
  (main))

(def (build-static)
  (defbuild-script
    '((static-exe: "ecm-gui" #;"-verbose" "-cc-options" "-v"))
    static: #t
    bindir: (path-expand "bin/" srcdir)
    optimize: #t
    debug: #f
                                        ; libdir: srcdir
    build-deps: "build-deps-bin" ; importantly, pick a file that differs from above
    ;verbose: 10
    )
  (main)
 ;;(g-compile-static-exe "ecm-gui")
                                        ;(display (gx#current-expander-module-library-path))
  )

(def (main . args) (build-lib) (build-static)
  )

#+end_src
